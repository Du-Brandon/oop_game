# 2025 OOPL Final Report

## 組別資訊

組別：P25
組員：杜詠霖
復刻遊戲：弓箭傳說

## 專案簡介

### 遊戲簡介
《弓箭傳說》是一款單手操作的Roguelite 動作遊戲。 世界即將被黑暗吞噬，作為弓箭手的你是最後希望，你將在無數個隨機生成的地牢中奮戰。 透過擊殺怪物後獲得的經驗值，升級手中武器，獲得千奇百怪的技能，並一步步朝最終關卡邁進。

### 組別分工
112820042 杜詠霖 100% 
## 遊戲介紹

### 遊戲規則
使用 W S A D 來控制上下左右，用滑鼠點擊技能。玩家必須避免被敵方碰觸及躲避子彈(一碰到就扣血)。每個地圖中有不同的障礙物阻擋玩家前進。<br>
(可按數字1、2增加攻擊、血量)
<br><br>
而玩家消滅敵人的方式則是射出弓箭。但，弓箭手(玩家)必須在原地時才能攻擊，移動時會因跑動而無法射擊。
<br><br>
當地圖上所有敵人被消滅後，玩家會獲取相應的經驗值。

### 遊戲畫面
1.遊玩畫面![](playing.png)
2.升級後選擇技能![](skill_choise.png)
3.送禮物的天使![](angle.png)
## 程式設計

### 程式架構
```mermaid
graph TD
    Update --> 是否升級
    Update --> 是否碰到天使
    Update --> Boss關邏輯
    Update --> 小怪關邏輯

    是否升級 -->  選技能
    是否碰到天使 --> 選技能

```

```mermaid
graph TD
    角色 --> 玩家
    角色 --> 敵人

    敵人 --> 小怪
    敵人 --> boss
    敵人 --> 天使

    玩家 --> HP
    敵人 --> HP

    玩家 --> 弓箭
    小怪 --> 敵人弓箭(enemyarrow)
    boss --> 敵人弓箭(enemyarrow)

    玩家 --> EXP
    玩家 --> 玩家狀態

    wall --> 弓箭
    wall --> 角色
    wall --> 敵人
    wall --> 敵人弓箭(enemyarrow)

```
### 程式技術

1.**分開的update邏輯**
> - 將普通關卡與常常遇到特殊情況的王關，以及選擇技能介面三者分開，減少update時的負荷
> -  普通關卡主要處理小怪的生成、移動及攻擊行為。
> - 王關專注於 Boss 的特殊技能及行為模式。
> - 選擇技能介面獨立處理玩家升級後的技能選擇，避免與遊戲主邏輯混雜。

2. **物件導向設計**
> -  使用 `玩家` 和 `敵人` 作為基底類別，分別衍生出 `小怪`、`Boss` 和 `天使`。
> -  每個角色都擁有自己的 `HP` 和行為邏輯，並透過多型實現不同的攻擊方式。
> - 其中 `enemy`物件本身就已提供大量且基礎的參數以及方法，讓我們能夠輕鬆地創建敵人角色。這些參數包括敵人的生命值、攻擊力、移動速度等，而方法則涵蓋了敵人的行為，如攻擊、移動。 且能用std::vector來儲存敵人，方便用迴圈來處理所有敵人。 

3. **技能系統**
> - 為了技能系統 而參考其他人的程式碼並弄出的 button物件 能夠創造出按鈕且此物件能夠根據技能函式的不同而改變外觀和行為。 

4. **記憶體管理**
> - 使用 `std::shared_ptr`進行管理，其中弓箭及敵人子彈都是在射出時生成，並在不需要時釋放。

5. **錯誤日誌**
> - 透過 `log_my.hpp` 來記錄錯誤日誌，方便除錯和追蹤問題。其中錯誤資訊會存在 `log.txt` 檔案中，此舉能改善原本在終端機輸出錯誤訊息的方式，讓錯誤資訊更易於查閱。

## 結語

### 問題與解決方法
由於我以前寫程式主要以python為主，很少用C++，完成這個專案遇到過很多的問題。<br><br>
一開始在創造`弓箭`時使用的是*的指標，但這造成了我在沒有寫好解構元的情況下常常 Memory Leak。撐了一個月後才改成std::shared_ptr<>的方法才解決。
<br><br>
遇到的第二個問題是 vector 的位置問題，當時在寫的時候忘記了每當新 push 物件到 vector 且原本的 vector 已滿時，會自動將原本的位置搬移並擴充，導致原本指向 vector 內部元素的指標失效，進而引發未定義行為。為了解決這個問題，我改用索引來存取 vector 內的元素，並在需要動態管理物件時，使用 `std::shared_ptr` 來確保記憶體安全性，避免因指標失效而導致程式崩潰。
<br><br>
後來遇到的問題是如何製作按鈕，畢竟每個按鈕的功能都不同，不太可能為了每個按鈕(技能)都做一個屬於自己的物件。為了解決這個問題，我請教了厲害的同學並創造了一個通用的按鈕類別，該類別可以根據傳入的參數動態改變按鈕的外觀和行為。按鈕的功能由綁定的回調函式決定，這樣就不需要為每個技能單獨創建物件。技能選擇介面則使用隨機技能生成機制，並通過按鈕綁定技能的回調函式，讓玩家能夠自由選擇技能。

此外，技能的效果被封裝在獨立的函式中，並且可以根據遊戲進程動態添加或移除技能，確保遊戲的靈活性和可擴展性。這樣的設計不僅減少了重複代碼，也讓技能系統更容易維護和擴展。
<br><br>
最後一個問題也是最大的問題，到現在還沒解決。在每次編譯完的第一ㄊ次執行遊戲時，當遊戲進入選技能階段，有機率讓整個遊戲卡頓。我嘗試了調整遊戲結構等方式卻找不出原因。原本打算去查系統堆疊，但Windows大部分的編譯器都無法跟我當時用的Windows Performance Analyzer衝突(無法看到函式名字)，而在Linux跟Mac上又不會觸發，目前只能先放著這個問題。
<br><br>
(額外的小問題，我在製作這款遊戲時，因為缺乏素材包及前人的作品參考，加上美術能力不足，讓我感到非常困難)

### 自評

| 項次 | 項目                   | 完成 |
|------|------------------------|-------|
| 1    | 完成協議書上所描述的最小關卡數量。  |  V  |
| 2    | 完成專案權限改為 public |  V  |
| 3    | 具有 debug mode 的功能  |  V  |
| 4    | 解決專案上所有 Memory Leak 的問題  |  V  |
| 5    | 報告中沒有任何錯字，以及沒有任何一項遺漏  |  V  |
| 6    | 報告至少保持基本的美感，人類可讀  |  V  |
| 7    | 寫得蠻開心的  |  V  |

### 心得
這門課我非常喜歡，用一個全新可自己摸索的框架去寫遊戲，將以前學過的東西拿來實用。有機會的話我想幫框架加上一點新的東西來幫助或改善開發者。

### 貢獻比例
我自己100%(沒有組員的孤兒)